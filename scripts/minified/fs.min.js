// fs.min.js, for SugarCube 2, by Chapel
;!function(){function i(t){return console.error(t),null}function a(t){try{return JSON.stringify(t)}catch(t){return i(t)}}function s(t){try{var e;if(void 0===t)return null;if(null!=(e="string"!=typeof t?a(t):t))return LZString.compressToBase64(e)}catch(t){return i(t)}}function o(t){try{return LZString.decompressFromBase64(t)}catch(t){return i(t)}}function c(e){try{return JSON.parse(e)}catch(t){try{return JSON.parse(o(e))}catch(t){return i(t)}}}function u(t,e){try{if("$"!==e[0]&&"_"!==e[0])throw new Error("Invalid stateful variable");State.setVar?State.setVar(e,clone(t)):"$"===e[0]?State.variables[e.substr(1)]=clone(t):State.temporary[e.substr(1)]=clone(t)}catch(t){return i(t)}}function l(t,e){if("string"!=typeof e&&(e=a(e)),null!=e){(t=t&&"string"==typeof t?Util.slugify(t.trim()).toLowerCase():"file.twinedata").includes(".")||(t+=".twinedata");try{saveAs(new Blob([e],{type:"text/plain;charset=UTF-8"}),t)}catch(t){return i(t)}}}function f(t){var e=t.target.files[0],r=new FileReader,n=t.storyVar||"$fileData",a=t.dataType||"text";$(r).on("load",function(t){try{var e=t.currentTarget;if(!e.result)return;u(function(t,e){if(null==e)return null;switch(t){case"json":return c(e);case"base64":case"b64":case"64":return c(o(e));default:return e}}(a,e.result),n)}catch(t){return i(t)}}),r.readAsText(e)}function p(t,e,r,n,a){var i,s=function(t,e,r,n){var a=$(document.createElement(n?"a":"button")).wiki(t),i=$(document.createElement("label")).attr("for","file-import").addClass("upload-file").append(a),s=$(document.createElement("input")).attr({id:"file-import",type:"file","data-format":r}).css("display","none").on("change",function(t){f(Object.assign(clone(t),{storyVar:e,dataType:$(this).attr("data-format")}))}),o=$(document.createElement("span")).append(i,s);return a.ariaClick(function(){i.trigger("click")}),o}(e,r,n,a);i=t&&"string"==typeof t?$(t):t||"#passages",s.appendTo(i)}setup.fileSystem={config:{defaultText:"Import",renderAsLink:!1},JSON:{stringify:a,parse:c},b64:{compress:s,decompress:o},toState:u,toFile:l,fromFile:f},window.Chapel=window.Chapel||{},Chapel.fileSystem=Chapel.fileSystem||setup.fileSystem,Macro.add("import",{handler:function(){var t=this.output,e=this.args[2],r=this.args[0],n=this.args[1];if(e&&"string"==typeof e||(e=setup.fileSystem.config.defaultText),!r||"string"!=typeof r||"$"!==r[0]&&"_"!==r[0])return this.error("Invalid variable name.");p(t,e,r,n=n&&"string"==typeof n?n.trim():"text",setup.fileSystem.config.renderAsLink)}}),Macro.add("export",{handler:function(){var t=this.args[0],e=this.args[1],r=this.args[2];if(!t)return this.error("No data to save...");r=r&&"string"==typeof r?r.trim():"text",function(t,e,r){var n;switch(r){case"json":n=a(t);break;case"base64":case"b64":case"64":n=s(a(t)||t);break;default:n="string"==typeof t?t:a(t)}l(e,n)}(t,e=e&&"string"==typeof e?e.trim():"file.twinedata",r)}})}();
// end fs.min.js