// fs.min.js, for SugarCube 2, by Chapel
;!function(){function i(t){return console.error(t),null}function n(t){try{return JSON.stringify(t)}catch(t){return i(t)}}function s(t){try{var e;if(void 0===t)return null;if(null!=(e="string"!=typeof t?n(t):t))return LZString.compressToBase64(e)}catch(t){return i(t)}}function o(t){try{return LZString.decompressFromBase64(t)}catch(t){return i(t)}}function c(e){try{return JSON.parse(e)}catch(t){try{return JSON.parse(o(e))}catch(t){return i(t)}}}function l(t,e){try{if("$"!==e[0]&&"_"!==e[0])throw new Error("Invalid stateful variable");State.setVar?State.setVar(e,clone(t)):"$"===e[0]?State.variables[e.substr(1)]=clone(t):State.temporary[e.substr(1)]=clone(t)}catch(t){return i(t)}}function u(t,e){if("string"!=typeof e&&(e=n(e)),null!=e){(t=t&&"string"==typeof t?Util.slugify(t.trim()).toLowerCase():"file.twinedata").includes(".")||(t+=".twinedata");try{saveAs(new Blob([e],{type:"text/plain;charset=UTF-8"}),t)}catch(t){return i(t)}}}function m(t){var e=t.target.files[0],r=new FileReader,a=t.storyVar||"$fileData",n=t.dataType||"text";$(r).on("load",function(t){try{var e=t.currentTarget;if(!e.result)return;l(function(t,e){if(null==e)return null;switch(t){case"json":return c(e);case"base64":case"b64":case"64":return c(o(e));default:return e}}(n,e.result),a)}catch(t){return i(t)}}),r.readAsText(e)}function f(t,e,r,a,n){var i,s,o,c,l,u,f,p,d,y=(s=e,o=r,c=a,l=n,u=$(document.createElement(l?"a":"button")).wiki(s),f=$(document.createElement("label")).attr("for","file-import").addClass("upload-file").append(u),p=$(document.createElement("input")).attr({id:"file-import",type:"file","data-format":c}).css("display","none").on("change",function(t){m(Object.assign(clone(t),{storyVar:o,dataType:$(this).attr("data-format")}))}),d=$(document.createElement("span")).append(f,p),u.ariaClick(function(){f.trigger("click")}),d);i=t&&"string"==typeof t?$(t):t||"#passages",y.appendTo(i)}setup.fileSystem={config:{defaultText:"Import",renderAsLink:!1},JSON:{stringify:n,parse:c},b64:{compress:s,decompress:o},toState:l,toFile:u,fromFile:m},window.Chapel=window.Chapel||{},Chapel.fileSystem=Chapel.fileSystem||setup.fileSystem,Macro.add("import",{handler:function(){var t=this.output,e=this.args[2],r=this.args[0],a=this.args[1];if(e&&"string"==typeof e||(e=setup.fileSystem.config.defaultText),!r||"string"!=typeof r||"$"!==r[0]&&"_"!==r[0])return this.error("Invalid variable name.");f(t,e,r,a=a&&"string"==typeof a?a.trim():"text",setup.fileSystem.config.renderAsLink)}}),Macro.add("export",{handler:function(){var t=this.args[0],e=this.args[1],r=this.args[2];if(!t)return this.error("No data to save...");r=r&&"string"==typeof r?r.trim():"text",function(t,e,r){var a;switch(r){case"json":a=n(t);break;case"base64":case"b64":case"64":a=s(n(t)||t);break;default:a="string"==typeof t?t:n(t)}u(e,a)}(t,e=e&&"string"==typeof e?e.trim():"file.twinedata",r)}})}();
// end fs.min.js